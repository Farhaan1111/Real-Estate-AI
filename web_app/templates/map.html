{% extends "base.html" %}

{% block title %}Project Map - Real Estate AI{% endblock %}

{% block extra_css %}
<style>
    .map-page {
        background: var(--bg-primary);
        min-height: 100vh;
    }
    
    .map-container {
        height: 600px;
        border-radius: 12px;
        border: 1px solid var(--border-primary);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        background: var(--bg-surface);
    }
    
    .map-controls {
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .project-card {
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 10px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary);
    }
    
    .project-card.active {
        border-color: var(--primary);
        background: var(--bg-tertiary);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        background: var(--bg-surface);
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 0.75rem;
        border: 2px solid var(--border-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="map-page">
    <div class="container py-4">
        <!-- Header -->
        <div class="row align-items-center mb-4">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <div class="chat-avatar me-3">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <div>
                        <h1 class="text-gradient mb-1">RERA Projects Map</h1>
                        <p class="text-muted mb-0">Explore registered real estate projects across India with interactive mapping</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group">
                    <a href="{{ url_for('chat') }}" class="btn btn-outline-modern">
                        <i class="fas fa-robot me-1"></i> AI Chat
                    </a>
                    <a href="{{ url_for('search') }}" class="btn btn-outline-modern">
                        <i class="fas fa-search me-1"></i> Search
                    </a>
                </div>
            </div>
        </div>

        {% if not map_available %}
        <!-- Error State -->
        <div class="card-dark text-center py-5">
            <div class="card-body">
                <i class="fas fa-exclamation-triangle fa-4x text-warning mb-4"></i>
                <h3 class="text-warning mb-3">Map Features Currently Unavailable</h3>
                <p class="text-muted mb-4">{{ error }}</p>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="/map-test" class="btn btn-primary-modern">
                        <i class="fas fa-cogs me-1"></i> Test Map Functionality
                    </a>
                    <a href="/setup" class="btn btn-outline-modern">
                        <i class="fas fa-tools me-1"></i> System Setup
                    </a>
                    <a href="/chat" class="btn btn-outline-modern">
                        <i class="fas fa-comment me-1"></i> Try AI Chat
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Main Map Content -->
        <div class="row">
            <!-- Map Controls & Info -->
            <div class="col-lg-4">
                <!-- Stats Card -->
                <div class="card-dark mb-4">
                    <div class="card-header-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Map Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="stat-number">{{ projects_count }}</div>
                                <div class="stat-label">Projects</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="stat-number" id="activeMarkers">4</div>
                                <div class="stat-label">Locations</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Showing sample data - Real project integration coming soon
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="card-dark mb-4">
                    <div class="card-header-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>Map Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label text-primary">Project Type</label>
                            <select class="form-select search-input" id="mapProjectType">
                                <option value="all">All Projects</option>
                                <option value="residential">Residential</option>
                                <option value="commercial">Commercial</option>
                                <option value="mixed">Mixed Use</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-primary">Status Filter</label>
                            <select class="form-select search-input" id="mapStatusFilter">
                                <option value="all">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="under_construction">Under Construction</option>
                                <option value="new">New Launch</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-modern" onclick="fitMapToBounds()">
                                <i class="fas fa-expand me-1"></i> Fit to All Markers
                            </button>
                            <button class="btn btn-outline-modern" onclick="refreshMap()">
                                <i class="fas fa-sync-alt me-1"></i> Refresh Map
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="card-dark mb-4">
                    <div class="card-header-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-key me-2"></i>Map Legend
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #10b981;"></div>
                            <span class="flex-fill">Residential Projects</span>
                            <i class="fas fa-home text-success"></i>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #3b82f6;"></div>
                            <span class="flex-fill">Commercial Projects</span>
                            <i class="fas fa-store text-primary"></i>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #8b5cf6;"></div>
                            <span class="flex-fill">Mixed Use Projects</span>
                            <i class="fas fa-building text-purple"></i>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #6b7280;"></div>
                            <span class="flex-fill">Other Projects</span>
                            <i class="fas fa-question text-secondary"></i>
                        </div>
                    </div>
                </div>

                <!-- Quick Projects List -->
                <div class="card-dark">
                    <div class="card-header-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Featured Projects
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="project-card" data-project="UNNATHI WOODS">
                            <h6 class="text-primary mb-1">UNNATHI WOODS PHASE VII A</h6>
                            <small class="text-muted d-block mb-1">Mumbai Suburban • Residential</small>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-success">Under Construction</small>
                                <button class="btn btn-sm btn-outline-modern" onclick="focusOnProject('UNNATHI WOODS')">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="project-card" data-project="SAMPLE COMMERCIAL">
                            <h6 class="text-primary mb-1">Business Tower One</h6>
                            <small class="text-muted d-block mb-1">Pune • Commercial</small>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-warning">New Launch</small>
                                <button class="btn btn-sm btn-outline-modern" onclick="focusOnProject('SAMPLE COMMERCIAL')">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="col-lg-8">
                <div class="card-dark">
                    <div class="card-header-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-globe-asia me-2"></i>
                            Interactive Project Map
                        </h5>
                        <span class="badge bg-success">
                            <i class="fas fa-signal me-1"></i> Live
                        </span>
                    </div>
                    <div class="card-body p-0">
                        <div class="map-container" id="map">
                            {{ map_html | safe }}
                        </div>
                    </div>
                </div>

                <!-- Map Features -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card-dark text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-layer-group fa-2x text-primary mb-3"></i>
                                <h6>Layer Control</h6>
                                <p class="text-muted small mb-0">Toggle between different project types and layers</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-search fa-2x text-success mb-3"></i>
                                <h6>Interactive Popups</h6>
                                <p class="text-muted small mb-0">Click markers for detailed project information</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark text-center h-100">
                            <div class="card-body">
                                <i class="fas fa-expand-arrows-alt fa-2x text-warning mb-3"></i>
                                <h6>Fullscreen Mode</h6>
                                <p class="text-muted small mb-0">Immersive map viewing experience</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coming Soon Features -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card-dark">
                    <div class="card-header-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-rocket me-2"></i>Coming Soon Features
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Real RERA project data integration
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Advanced filtering and search
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Project comparison tools
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Heat maps for project density
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Export project locations
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Route planning to projects
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/chat?query=Tell me about the map features and future updates" 
                               class="btn btn-primary-modern">
                                <i class="fas fa-robot me-1"></i> Ask AI About Future Features
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Map interaction functions
function fitMapToBounds() {
    showNotification('Fit to bounds feature will be implemented in the next update', 'info');
}

function refreshMap() {
    showNotification('Refreshing map...', 'info');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function focusOnProject(projectName) {
    showNotification(`Focusing on ${projectName}...`, 'info');
    // Implementation for focusing on specific project would go here
}

function showNotification(message, type = 'info') {
    if (window.realEstateApp) {
        window.realEstateApp.showNotification(message, type);
    } else {
        // Fallback notification
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
}

// Initialize map controls
document.addEventListener('DOMContentLoaded', function() {
    const projectTypeFilter = document.getElementById('mapProjectType');
    const statusFilter = document.getElementById('mapStatusFilter');
    
    if (projectTypeFilter) {
        projectTypeFilter.addEventListener('change', function() {
            showNotification(`Filtering by: ${this.value} projects`, 'info');
        });
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            showNotification(`Filtering by status: ${this.value}`, 'info');
        });
    }
    
    // Add hover effects to project cards
    document.querySelectorAll('.project-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>
{% endblock %}